---
title: Assignment 1) Forecasting temperature anomalies
output: html_notebook
---

# Initialize
```{r}
rm(list = ls());
graphics.off();
cat("\014");
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(ggplot2)
library(dplyr)
```
# Functions for predictions
```{r}
#' Function that defines the linear trend model
f <- function(j){
  c(1,j)
}

# Functions for updating Fn to Fm
# calling F(n) updates F0 to Fn
update_F<-function(m, lambda=1, Fn=matrix(0,nrow=2,ncol=2), n=0){
  if(n>m){return(NaN)}
  if(n==m){return(Fn)}
  for (j in n:(m-1)){Fn = Fn + lambda^j*f(-j)%*%t(f(-j))}
  Fn
}

update_h<-function(m,Y, lambda=1, hn=c(0,0), n=0){
  if(n>m){return(NaN)}
  if(n==m){return(hn)}
  L=matrix(c(1,1,0,1),nrow=2)
  for (j in n:(m-1)){hn = lambda*solve(L)%*%hn + f(0)*Y[j+1]}
  c(hn) #return as vector instead of matrix
}

# Function that calculates theta_n for all n in N (N should be in increasing 
# order). Output is a 2xn matrix or a 2D vector if N is a scalar.
calculate_theta<-function(N, Y, lambda=1){
  len=length(N)
  theta=theta=matrix(0,nrow=2,ncol=len)
  
  #initialise FN and hN and calculate first theta
  #if N=1 the estimate of theta is just [Y_1, 0] -> from where??? WLS?
  hn=update_h(N[1],Y,lambda=lambda)
  Fn=update_F(N[1],lambda=lambda)
  if(N[1]==1){ theta[,1]=hn }
  else{ theta[,1] = solve(Fn,hn) }
  
  if(len==1){ return(c(theta)) }
  
  # iteratively calculations of the remaining thetas using the updating formulas
  for (i in 1:(len-1)){
    Fn=update_F(N[i+1], lambda=lambda, Fn=Fn, n=N[i])
    hn=update_h(N[i+1], Y, lambda=lambda, hn=hn, n=N[i])
    theta[,i+1]=solve(Fn,hn)}
  theta
}

#retruns a data.frame there coloumns indicate the used theta_N value, and rows
#indicates the predicting steps.
make_predictions <- function(N,Y, lambda=1,step=1){
  theta=calculate_theta(N, Y, lambda=lambda)
  f_=cbind(1,step)
  pred_=f_%*%theta
  df=data.frame(pred_, row.names=step)
  colnames(df)=N
  df
}


```

# Functions for confidence intervals
```{r}
##### confidence intervals  
sigma2_hat <- function(N,theta,Y){ # local estimator??? use residuals to tell whether global or local estiamte of variance should be used
  y=Y[1:N]
  x=cbind(1,(-N+1):0)
  tmp=y-x%*%theta
  c(t(tmp)%*%tmp/(N-2))
}
sigma2_hat_local <- function(N,theta,Y,lambda){
  p=2
  x=cbind(1,(-N+1):0)
  T_=0
  sigma=c()
  for(j in 0:(N-1)){
    T_=T_+lambda^j
    sigma=c((lambda^j), sigma)
  }
  sigma=diag(sigma)
  c(1/(T_-p)*t(Y-x%*%theta)%*%sigma%*%(Y-x%*%theta))
}
var_pred_err_local <- function(N,theta,Y, lambda,step,type='pred'){
  f_=rbind(1,step)
  FN=update_F(N,lambda=lambda)
  if (type=='pred'){
    diag(sigma2_hat_local(N,theta,Y,lambda)*(1+t(f_)%*%solve(FN)%*%f_))
  }else if (type=='conf'){
    diag(sigma2_hat_local(N,theta,Y,lambda)*(t(f_)%*%solve(FN)%*%f_))
  }
}

pred_interval_local <- function(N,theta,Y, lambda,step, conf=0.95,type='pred'){
  qt((1+conf)/2,df=N-2)*sqrt(var_pred_err_local(N,theta,Y,lambda, step,type))
}


var_pred_err <- function(N,theta,Y, lambda,step,type='pred'){
  f_=rbind(1,step)
  FN=update_F(N,lambda=lambda)
  if (type=='pred'){
    diag(sigma2_hat(N,theta,Y)*(1+t(f_)%*%solve(FN)%*%f_))
  }else if (type=='conf'){
    diag(sigma2_hat(N,theta,Y)*(t(f_)%*%solve(FN)%*%f_))
  }
}
pred_interval <- function(N,theta,Y, lambda,step, conf=0.95,type='pred'){
  qt((1+conf)/2,df=N-2)*sqrt(var_pred_err(N,theta,Y,lambda, step,type))
}

```
# Read data
```{r}
keeps <- c('year','nh')
data <- read.table("A1_annual.txt", header = TRUE)[keeps]  %>%
  mutate(data_type = c(replicate(164, 'Training'),replicate(5, 'Test')))
head(data)
tail(data)
```
# Question 1 - data visualisation
```{r}
plot_data <- ggplot() +
      geom_point(data=data,aes(x=year, y=nh,color=data_type)) +
      geom_line(data=data,aes(x=year, y=nh),col='black') +
      labs(title="Temperature anomality for the Northern hemisphere", 
           x="year", y="Temperature",  color = "Data") +
      theme(plot.title = element_text(size = 14, face = "bold", 
            color = "darkgreen"), legend.position = "right")
ggsave(file="data.pdf", plot=plot_data , width=8, height=5)
plot_data 
```
# Question 2-3 - global and local model (lambda=1 and lambda=0.8)
```{r}
lambda=0.8
#global one step predictions for the test data
pred = as.numeric(make_predictions(N=1:164,Y=data$nh, lambda=lambda,step=1))  #Y_N+1|N
pred_err = data$nh[2:164]-pred[-164] #Y_N+1-Y_N+1|N (Y_165 isn't training data)
forecast = make_predictions(N=164,Y=data$nh, lambda=lambda,step=1:5)$'164' #Y_N+l|N

#confidence intervals upper an lower bounds is calculated
theta_164=calculate_theta(N=164,Y=data$nh, lambda=lambda)
if (lambda==1){
  pred_uncertainty = pred_interval(N=164,theta=theta_164,Y=data$nh, 
                                   lambda=lambda,step=1:5,type='pred')
  conf_uncertainty = pred_interval(N=164,theta=theta_164,Y=data$nh, 
                                   lambda=lambda,step=1:5,type='conf')
}else{
  pred_uncertainty = pred_interval_local(N=164,theta=theta_164,Y=data$nh[1:164], 
                                   lambda=lambda,step=1:5,type='pred')
  conf_uncertainty = pred_interval_local(N=164,theta=theta_164,Y=data$nh[1:164], 
                                   lambda=lambda,step=1:5,type='conf')
}
plwr = forecast-pred_uncertainty
pupr = forecast+pred_uncertainty
clwr = forecast-conf_uncertainty
cupr = forecast+conf_uncertainty



#plot of one step predictions
plot_one_step <- plot_data +
  geom_point(aes(x=data$year[2:165], y=pred), color='red',size=0.2)+
  geom_line( aes(x=data$year[2:165], y=pred), color='red',size=0.2)
#ggsave(file="global.pdf", plot=plot_one_step, width=8, height=5)

#plot of one step predictions errors
plot_pred_err=ggplot()+
  geom_hline(yintercept = 0)+
  geom_point(aes(x=data$year[2:164],y=pred_err),pch=1)+
  labs(title="One step prediction errors - global Model",
       x="year", y="error")+
  theme(plot.title = element_text(size = 20,face = "bold",color = "darkgreen"))
#ggsave(file="resplotglobal.pdf", plot=plot_pred_err, width=10, height=6)

#plot of forecasted values
plot_forecast <- plot_one_step +
  geom_point(aes(x=data$year[165:169], y=forecast), 
             color='black',size=0.2)+
  geom_line( aes(x=data$year[165:169], y=forecast), color='black',
             size=0.2)+
  geom_line(aes(x=data$year[165:169],y=plwr),col='red',size=1)+
  geom_line(aes(x=data$year[165:169],y=pupr),col='red',size=1)+
  geom_line(aes(x=data$year[165:169],y=clwr),col='green',size=1)+
  geom_line(aes(x=data$year[165:169],y=cupr),col='green',size=1)+
  labs(title='Forecasting temperature anomality using Global Trend Model')
#ggsave(file="global.pdf", plot=plot_forecast, width=8, height=5)

#close up plot of forecasted values
plot_close<-plot_data+
  geom_point(aes(x=data$year[2:165], y=pred), color='red')+
  geom_line( aes(x=data$year[2:165], y=pred), color='red')+
  geom_point(aes(x=data$year[165:169],y=forecast),col='black')+
  geom_line(aes(x=data$year[165:169],y=forecast),col='black')+
  geom_line(aes(x=data$year[165:169],y=plwr),col='red')+
  geom_line(aes(x=data$year[165:169],y=pupr),col='red')+
  geom_line(aes(x=data$year[165:169],y=clwr),col='green')+
  geom_line(aes(x=data$year[165:169],y=cupr),col='green')+
  xlim(2000, 2018)+ylim(-0.4,1.2)+labs(title="Forecasting using Global Trend Model")
#ggsave(file="global2.pdf", plot=plot_close, width=5, height=4)
plot_one_step
plot_pred_err
plot_forecast
plot_close
```
# Question 4
Optimize for lambda
```{r}
##### optimering af lambda
prediction_error_SSE <- function(lambda,N,Y,step=1){
  pred_ = as.numeric(make_predictions(N,data$nh,lambda=lambda,step=step))
  #sum squared error
  norm(pred_-Y[N+1],type="2")
}

##### optimering af lambda
sse_err=c()
lambdas=seq(0.01,1,by=0.01)
N=6:163  #what residuals to count
for(lambda in lambdas) {
  sse_err=c(sse_err,prediction_error_SSE(lambda,N,data$nh))
}

opt=optimize(prediction_error_SSE,lower=0,upper=1,Y=data$nh,N=N)
plot(lambdas,sse_err,type='l',main=opt$minimum)+
abline(v=opt$minimum)

```

